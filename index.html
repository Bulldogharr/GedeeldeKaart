<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <title>Gedeelde Kaart met Opslaan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    body { font-family: Arial, sans-serif; padding:10px; }
    #map { height:80vh; margin-top:10px; }
    input, select, button { margin:4px; }
  </style>
</head>
<body>

<h1>Kaart van Gemeente Ede — Gedeeld</h1>

<input type="text" id="streetName" placeholder="Straatnaam (bijv. Mendellaan, Ede)">
<input type="text" id="popupText" placeholder="Popup‑tekst">
<select id="circleColor">
  <option value="green">Groen</option>
  <option value="orange">Oranje</option>
  <option value="red">Rood</option>
  <option value="blue">Blauw</option>
</select>
<select id="circleRadius">
  <option value="250">250 meter</option>
  <option value="300">300 meter</option>
  <option value="400">400 meter</option>
</select>
<button id="add">Voeg cirkel toe</button>
<button id="save">Opslaan in JSONBin</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
const API_URL = "https://api.jsonbin.io/v3/b/68f4f54843b1c97be97113ae";
const API_KEY = "$2a$10$.wg1M0zJ8TcaaMsUOev/yeNAzEPXW1h8AtiFroJ.TsRd/G9Kc7JCu";

const map = L.map('map').setView([52.046, 5.671], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

let circles = [];  // lokale lijst van cirkels

async function loadCircles() {
  const res = await fetch(API_URL + "/latest", { headers: { "X-Master-Key": API_KEY } });
  const json = await res.json();
  circles = json.record || [];
  drawCircles();
}

function drawCircles() {
  // Eerst alle bestaande lagen verwijderen
  map.eachLayer(layer => {
    if (layer instanceof L.Circle || layer instanceof L.CircleMarker) map.removeLayer(layer);
  });

  circles.forEach((c, index) => {
    const circle = L.circle([c.lat, c.lon], {
      color: c.color,
      fillColor: c.fillColor,
      fillOpacity: 0.5,
      radius: c.radius
    }).addTo(map);

    circle.bindPopup(`${c.popupText} <br> Radius: ${c.radius} m`);

    // Rechtsklik = cirkel verwijderen
    circle.on('contextmenu', () => {
      if (confirm("Wil je deze cirkel verwijderen?")) {
        circles.splice(index, 1);
        drawCircles();  // herteken de kaart
      }
    });
  });
}

// Functie om alles op JSONBin op te slaan
async function saveCircles() {
  await fetch(API_URL, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-Master-Key": API_KEY
    },
    body: JSON.stringify(circles)
  });
  alert("Cirkeldata succesvol opgeslagen!");
}

// Toevoegen van een nieuwe cirkel
document.getElementById("add").onclick = async () => {
  const street = document.getElementById("streetName").value;
  const popupText = document.getElementById("popupText").value;
  const color = document.getElementById("circleColor").value;
  const radius = parseInt(document.getElementById("circleRadius").value);
  if (!street) return alert("Voer straatnaam in");

  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(street)}`);
  const data = await res.json();
  if (!data.length) return alert("Straat niet gevonden");

  const lat = parseFloat(data[0].lat);
  const lon = parseFloat(data[0].lon);
  const fillColor = color === "green" ? "#00f033" :
                    color === "orange" ? "#FFA500" :
                    color === "red" ? "#FF0000" :
                    "#0000FF";

  const newC = { lat, lon, popupText: popupText || street, color, fillColor, radius };
  circles.push(newC);
  drawCircles();
  map.setView([lat, lon], 14);
};

// Opslaan-knop
document.getElementById("save").onclick = saveCircles;

loadCircles();
</script>

</body>
</html>
